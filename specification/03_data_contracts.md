# 03 — Data Contracts

This system persists all work into the `data/` directory. This document specifies the **authoritative folder and file contracts**.

## 1. Seed data

### `data/nations_seed/seed.csv`

A CSV defining which nations are in scope and their metadata.

- Required columns:
  - `country_name`
  - `iso3`
- Additional columns are used for rankings/selection provenance.

This file is read by:

- `src/data_acquisition/windowed_acquisition.py`
- `src/data_acquisition/main.py`
- `src/forecasting/windowed_forecast.py` (for internal `country_name` redaction)

### `data/nations_seed/external_drivers.json`

Defines per-target external “driver” countries for cross-nation interaction processing.

Schema:

- Root keys:
  - `_description` (string)
  - `_usage` (string)
  - `drivers` (object)
- `drivers` maps ISO3 → object containing arrays:
  - `economic`, `political`, `security`, `energy`, `migration`, `primary`
- `drivers._default` provides fallback driver lists.

Used by `src/processing/cross_nation_interactions.py`.

## 2. Raw acquisition artifacts

### 2.1 Nation raw data

Root:

- `data/raw_nation_data/<ISO3>/<WINDOW_LABEL>/<SOURCE_ID>/<YYYYMMDD>/<SHA256>.<ext>`

Where:

- `WINDOW_LABEL` is `YYYY_YYYY` (end-exclusive).
- `SOURCE_ID` is a stable identifier (see “Source ID format”).
- `YYYYMMDD` is the download date.
- `<SHA256>.<ext>` is the downloaded content.
- A **sidecar** JSON exists at:
  - `<SHA256>.<ext>.json`

Failure sidecars:

- `FAILED_<YYYYMMDDTHHMMSSZ>_<url_sha256>.json`

Generated by `src/data_acquisition/downloader.py`.

### 2.2 Global raw data

Root:

- `data/raw_global_data/global/<WINDOW_LABEL>/<SOURCE_ID>/<YYYYMMDD>/<SHA256>.<ext>`

For baseline datasets:

- `data/raw_global_data/global/all_time/...`

### 2.3 Sidecar JSON schema (download metadata)

Written by `DataDownloader.fetch_and_save()`.

Fields:

- `iso3` (string)
- `country_name` (string)
- `source_id` (string)
- `category` (string)
- `url` (string)
- `accessed_utc` (ISO datetime)
- `content_type` (string)
- `retrieval_method` (string)
- `checksum_sha256` (string)
- `file_path_relative` (string)
- `status` (`success` | `rejected` | `error`)
- `error_message` (string; present on failure)
- window metadata (when used in windowed acquisition):
  - `window_label`
  - `window_start_year`
  - `window_end_year_exclusive`

### 2.4 Source manifests

Windowed acquisition writes manifests under:

- `data/raw_nation_data/_meta/<WINDOW_LABEL>/sources_manifest_<RUN_TS>.csv`
- `data/raw_nation_data/_meta/<WINDOW_LABEL>/sources_manifest_<RUN_TS>.json`
- `data/raw_nation_data/_meta/<WINDOW_LABEL>/collection_report_<RUN_TS>.md`

Global acquisition writes manifests under:

- `data/raw_global_data/_meta/<WINDOW_LABEL>/sources_manifest_<RUN_TS>.csv`
- `data/raw_global_data/_meta/<WINDOW_LABEL>/sources_manifest_<RUN_TS>.json`
- `data/raw_global_data/_meta/<WINDOW_LABEL>/collection_report_<RUN_TS>.md`

Manifest row schema (CSV/JSON) in windowed acquisition:

- `window_label`
- `window_start_year`
- `window_end_year_exclusive`
- `source_id`
- `iso3` (or `GLOBAL`)
- `country_name`
- `category`
- `source_name`
- `url_root`
- `url_example`
- `access_method` (currently `http_get`)
- `language` (string)
- `coverage_hint` (string)
- `update_frequency_hint` (string)
- `license_or_terms_hint` (string)
- `notes` (string)

## 3. Source ID format

A source is identified as `source_id` and will be used in citations.

### 3.1 Tavily-discovered sources

Generated in `src/data_acquisition/discovery.py`:

- `source_id = "<ISO3>_<CAT>_<url_hash10>"`
- `url_hash10` is the first 10 hex chars of `sha256(url)`.

### 3.2 Wikipedia fallback sources

Generated in `src/data_acquisition/discovery.py`:

- `source_id = "<ISO3>_<CAT>_WIKI_<hash6>"`
- `hash6` is the first 6 hex chars of `sha256(url)`.

### 3.3 Global sources

Use explicit IDs such as:

- `GLOBAL_WIKI_2010S`
- `GLOBAL_WB_POP`

Defined in `SourceDiscovery.get_global_sources_for_window()` and `get_global_sources()`.

## 4. Processed artifacts (windowed)

### 4.1 Nation processed data

Root:

- `data/processed_nation_data/<ISO3>/<WINDOW_LABEL>/`

Files written by `src/processing/windowed_mindset.py`:

- `<ISO3>_evidence.md` — evidence dump (excerpts)
- `<ISO3>_block_<NN>_summary.md` — block-level LLM summary
- `<ISO3>_block_summaries.md` — concatenation
- `<ISO3>_state.md` — final window state snapshot
- `<ISO3>_citation_fixes.json` — only when citation auto-fix was applied

### 4.2 Global processed data

Root:

- `data/processed_global_data/global/<WINDOW_LABEL>/`

Files written by `src/processing/windowed_global_state.py`:

- `global_evidence.md`
- `global_block_<NN>_summary.md`
- `global_block_summaries.md`
- `global_state.md`

### 4.3 Cross-nation interaction context

Root:

- `data/processed_nation_data/<ISO3>/_interactions/`

Written by `src/processing/cross_nation_interactions.py`:

- `interaction_context.json`
- `interaction_summary.md`

## 5. Forecast artifacts

### 5.1 Non-windowed forecast (JSON)

Written by `src/forecast/forecaster.py`:

- `data/forecasts/<anon_id>_forecast.json`

Schema is described in `07_forecasting_and_evaluation.md`.

### 5.2 Windowed forecast (Markdown)

Written by `src/forecasting/windowed_forecast.py`:

- `data/forecasts/<timestamp>_<anon_id>_<start>_<end>/forecast.md`
- optional evaluation:
  - `forecast-evaluation.md`

### 5.3 Scenario forecast (Markdown)

Written by `src/forecasting/scenario_forecaster.py`:

- `data/forecasts/<timestamp>_<anon_id>_<start>_<end>_scenarios/scenario_forecast.md`
- optional evaluation:
  - `scenario_evaluation.md`

## 6. Reporting artifacts

### PDF report

Written by `src/reporting/reportlab_report.py`:

- `data/forecasts/<timestamp>_<anon_id>_<WINDOW_LABEL>/forecast_report.pdf`

## 7. Facade / anonymization mapping

Current repository uses **two mapping artifacts**:

- `data/facade/mapping.csv`
  - Created/managed by `src/anonymise/facade_manager.FacadeManager`.

- `data/facade/mappings.json`
  - Read by:
    - `src/forecasting/windowed_forecast.py`
    - `src/reporting/reportlab_data.py`
  - This file is not written by the current codebase; it must exist (or be generated externally).

See `09_anonymisation_and_blindness.md` for implications.
